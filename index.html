# AI-Enhanced SMS Reminder System with Google Gemini
# Run this in Google Colab for free SMS reminders with AI personalization

# Install required packages (run this cell first in Colab)
# !pip install google-generativeai twilio pandas

import google.generativeai as genai
import pandas as pd
from twilio.rest import Client
from datetime import datetime, timedelta
import time
import json

# Configuration
CONFIG = {
    # Google AI Studio API (FREE)
    'google_api_key': 'YOUR_GOOGLE_AI_STUDIO_API_KEY',  # Get from aistudio.google.com
    
    # Twilio Configuration
    'twilio_sid': 'YOUR_TWILIO_ACCOUNT_SID',
    'twilio_token': 'YOUR_TWILIO_AUTH_TOKEN', 
    'twilio_phone': '+1234567890',  # Your Twilio number
    
    # Clinic Information
    'clinic_name': 'Bright Smile Dental',
    'clinic_phone': '(555) 123-4567',
    'clinic_address': '123 Main Street, Downtown'
}

def setup_ai():
    """Initialize Google AI"""
    genai.configure(api_key=CONFIG['google_api_key'])
    return genai.GenerativeModel('gemini-1.5-flash')

def create_personalized_reminder(model, patient_name, treatment_type, appointment_date, patient_notes=None):
    """
    Use AI to create personalized appointment reminders
    """
    formatted_date = appointment_date.strftime("%B %d, %Y at %I:%M %p")
    
    prompt = f"""
    Create a friendly, professional SMS appointment reminder for a dental patient. 

    Patient Details:
    - Name: {patient_name}
    - Treatment: {treatment_type}
    - Appointment: {formatted_date}
    - Clinic: {CONFIG['clinic_name']}
    - Phone: {CONFIG['clinic_phone']}
    
    Additional notes: {patient_notes or 'None'}
    
    Requirements:
    - Keep it under 160 characters if possible (SMS limit)
    - Be warm and reassuring (many people have dental anxiety)
    - Include key preparation instructions for the specific treatment
    - Add a touch of personalization
    - Include clinic phone for questions
    - Use emojis sparingly but effectively
    
    Treatment-specific tips:
    - Cleaning: Brush beforehand, arrive 15 min early
    - Filling: Light meal beforehand, bring headphones if anxious
    - Crown: Avoid hard foods day before
    - Whitening: Avoid coffee/tea day before
    - Extraction: Arrange ride home, eat soft foods after
    - Emergency: We're here to help, don't worry
    
    Write just the SMS message, nothing else.
    """
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        # Fallback message if AI fails
        return f"Hi {patient_name}! Reminder: {treatment_type} appointment tomorrow at {formatted_date}. Please arrive 15 min early. Questions? Call {CONFIG['clinic_phone']} ü¶∑"

def send_ai_reminder(model, patient_name, patient_phone, appointment_date, treatment_type, patient_notes=None):
    """
    Send AI-generated personalized SMS reminder
    """
    try:
        # Generate personalized message using AI
        message_body = create_personalized_reminder(
            model, patient_name, treatment_type, appointment_date, patient_notes
        )
        
        # Send SMS via Twilio
        client = Client(CONFIG['twilio_sid'], CONFIG['twilio_token'])
        message = client.messages.create(
            body=message_body,
            from_=CONFIG['twilio_phone'],
            to=patient_phone
        )
        
        print(f"‚úÖ AI reminder sent to {patient_name}")
        print(f"   üì± Message: {message_body}")
        print(f"   üÜî SID: {message.sid}")
        return True
        
    except Exception as e:
        print(f"‚ùå Failed to send AI reminder to {patient_name}: {str(e)}")
        return False

def load_appointments_with_ai_data(csv_file_path):
    """
    Load appointment data with additional fields for AI personalization
    Expected columns: name, phone, appointment_date, treatment_type, notes, patient_anxiety_level, preferred_communication_style
    """
    try:
        df = pd.read_csv(csv_file_path)
        df['appointment_date'] = pd.to_datetime(df['appointment_date'])
        return df
    except Exception as e:
        print(f"Error loading CSV: {str(e)}")
        return None

def analyze_patient_sentiment(model, patient_notes):
    """
    Use AI to analyze patient sentiment and adjust message tone
    """
    if not patient_notes:
        return "neutral"
    
    prompt = f"""
    Analyze this patient note for sentiment and anxiety level:
    "{patient_notes}"
    
    Respond with just one word:
    - "anxious" if they seem worried or nervous
    - "excited" if they seem positive or eager
    - "neutral" if no clear emotion
    - "pain" if they mention discomfort or emergency
    """
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip().lower()
    except:
        return "neutral"

def send_ai_powered_daily_reminders():
    """
    Main function with AI-enhanced personalization
    """
    print(f"ü§ñ AI-Enhanced Reminder System Starting...")
    print(f"üîç Checking appointments for {(datetime.now() + timedelta(days=1)).strftime('%B %d, %Y')}")
    
    # Initialize AI
    try:
        model = setup_ai()
        print("‚úÖ Google AI connected successfully")
    except Exception as e:
        print(f"‚ùå AI setup failed: {e}")
        return
    
    # Load appointments
    appointments_df = load_appointments_with_ai_data('appointments_enhanced.csv')
    
    if appointments_df is None:
        print("‚ùå Failed to load appointments data")
        return
    
    # Filter for tomorrow's appointments
    tomorrow = datetime.now() + timedelta(days=1)
    tomorrow_appointments = appointments_df[
        appointments_df['appointment_date'].dt.date == tomorrow.date()
    ]
    
    if tomorrow_appointments.empty:
        print("üìÖ No appointments found for tomorrow")
        return
    
    print(f"üì± Found {len(tomorrow_appointments)} appointments. Generating AI reminders...")
    
    successful_sends = 0
    
    for index, row in tomorrow_appointments.iterrows():
        # Analyze patient sentiment for tone adjustment
        sentiment = analyze_patient_sentiment(model, row.get('notes', ''))
        
        success = send_ai_reminder(
            model=model,
            patient_name=row['name'],
            patient_phone=row['phone'], 
            appointment_date=row['appointment_date'],
            treatment_type=row['treatment_type'],
            patient_notes=row.get('notes', None)
        )
        
        if success:
            successful_sends += 1
        
        # Small delay between messages
        time.sleep(2)
    
    print(f"\nüéØ AI Reminder Summary:")
    print(f"   Total appointments: {len(tomorrow_appointments)}")
    print(f"   Successful AI reminders: {successful_sends}")
    print(f"   Failed reminders: {len(tomorrow_appointments) - successful_sends}")

def create_enhanced_sample_csv():
    """
    Create sample CSV with enhanced fields for AI personalization
    """
    sample_data = {
        'name': [
            'John Smith',
            'Sarah Johnson', 
            'Mike Davis',
            'Emily Wilson',
            'David Brown'
        ],
        'phone': [
            '+1234567890',
            '+1987654321',
            '+1555123456', 
            '+1444987654',
            '+1333444555'
        ],
        'appointment_date': [
            '2025-08-11 10:00:00',  # Tomorrow
            '2025-08-11 14:30:00', 
            '2025-08-11 09:15:00',
            '2025-08-11 16:00:00',
            '2025-08-11 11:30:00'
        ],
        'treatment_type': [
            'Cleaning & Checkup',
            'Filling',
            'Crown Placement', 
            'Teeth Whitening',
            'Tooth Extraction'
        ],
        'notes': [
            'First time patient, mentioned anxiety about dental visits',
            'Previous patient, very comfortable with procedures',
            'Needs crown for back molar, prefers morning appointments',
            'Excited about whitening for wedding next month',
            'Emergency extraction, was in pain last week'
        ],
        'patient_anxiety_level': [
            'high',
            'low',
            'medium', 
            'low',
            'medium'
        ],
        'preferred_communication_style': [
            'reassuring',
            'direct',
            'detailed',
            'friendly', 
            'supportive'
        ]
    }
    
    df = pd.DataFrame(sample_data)
    df.to_csv('appointments_enhanced.csv', index=False)
    print("‚úÖ Enhanced sample appointments_enhanced.csv created!")
    print("üìã Includes fields for AI personalization:")
    print("   - Patient notes for context")
    print("   - Anxiety levels for tone adjustment") 
    print("   - Communication preferences")

# Advanced features
def send_follow_up_survey(model, patient_name, patient_phone, treatment_type):
    """
    Send AI-generated follow-up survey after appointment
    """
    prompt = f"""
    Create a brief, friendly follow-up text message for a patient who just had {treatment_type} at {CONFIG['clinic_name']}.
    
    Requirements:
    - Thank them for coming
    - Ask how they're feeling (1-2 simple questions)
    - Invite feedback
    - Provide aftercare tips specific to {treatment_type}
    - Keep under 160 characters
    - Include clinic phone for questions
    
    Write just the SMS message.
    """
    
    try:
        response = model.generate_content(prompt)
        message_body = response.text.strip()
        
        client = Client(CONFIG['twilio_sid'], CONFIG['twilio_token'])
        message = client.messages.create(
            body=message_body,
            from_=CONFIG['twilio_phone'],
            to=patient_phone
        )
        
        print(f"üìã Follow-up survey sent to {patient_name}")
        return True
    except Exception as e:
        print(f"‚ùå Failed to send follow-up to {patient_name}: {e}")
        return False

def generate_appointment_insights(model, appointments_df):
    """
    Use AI to analyze appointment patterns and generate insights
    """
    # Prepare data summary
    summary = {
        'total_appointments': len(appointments_df),
        'treatment_types': appointments_df['treatment_type'].value_counts().to_dict(),
        'common_concerns': appointments_df['notes'].tolist(),
        'peak_hours': appointments_df['appointment_date'].dt.hour.value_counts().head(3).to_dict()
    }
    
    prompt = f"""
    Analyze this dental clinic appointment data and provide insights:
    
    {json.dumps(summary, indent=2)}
    
    Please provide:
    1. Most popular treatments
    2. Common patient concerns
    3. Busiest appointment times
    4. Recommendations for clinic operations
    5. Patient communication suggestions
    
    Keep it concise and actionable.
    """
    
    try:
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"Could not generate insights: {e}"

# Main execution
if __name__ == "__main__":
    print("ü¶∑ü§ñ AI-Enhanced Dental Reminder System")
    print("=" * 50)
    
    # Create enhanced sample data
    create_enhanced_sample_csv()
    
    # Send AI-powered reminders
    send_ai_powered_daily_reminders()
    
    # Optional: Generate insights
    # appointments_df = load_appointments_with_ai_data('appointments_enhanced.csv')
    # if appointments_df is not None:
    #     model = setup_ai()
    #     insights = generate_appointment_insights(model, appointments_df)
    #     print("\nüìä AI INSIGHTS:")
    #     print(insights)
